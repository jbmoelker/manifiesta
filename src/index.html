<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Manifiesta</title>
    <meta name="description" content="Configure and preview your Progressive Web App Manifest.">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="index.css" rel="stylesheet">
</head>
<body>
<h1>Manifiesta</h1>

<form data-settings-form>
    <div>
        <label for="scaleInput">Zoom</label>
        <input name="scale" id="scaleInput" type="range" value="0.7" min="0" max="1" step="0.05">
        <output for="scaleInput">70%</output>
    </div>
    <fieldset>
        <legend>Orientation</legend>
        <label><input name="orientation" type="radio" value="portrait" checked>portrait</label>
        <label><input name="orientation" type="radio" value="landscape">landscape</label>
    </fieldset>
</form>

<div class="grid">

    <div class="grid__item">
        <form class="form" data-manifest-form>
            <div>
                <label for="siteUrl">Site URL</label>
                <input id="siteUrl" name="siteUrl" type="url" required value="https://www.voorhoede.nl">
            </div>
            <button type="button" data-manifest-form__fetch>Fetch manifest from site</button>
            <div>
                <label for="manifest">Manifest (JSON)</label>
                <textarea id="manifest" name="manifest" required></textarea>
            </div>
            <button type="submit">Preview</button>
        </form>
    </div>

    <div class="grid__item">
        <div class="device device--nexus-5x">
            <!-- @todo: add and configure `sandbox` on iframe? -->
            <div class="device__viewport device__viewport--nexus-5x browser-screen" data-browser-screen>
                <div class="browser-screen__top-bar">
                    <input readonly class="browser-screen__url-input" data-browser-screen__url-input>
                    <button>1</button>
                    <button disabled>.</button>
                </div>
                <iframe src="" frameborder="0" class="browser-screen__content" data-browser-screen__content></iframe>
                <div class="browser-screen__prompt">
                    <button type="button" class="browser-screen__prompt-close">Ã—</button>
                    <img class="browser-screen__prompt-icon" data-browser-screen__prompt-icon>
                    <span class="browser-screen__prompt-title" data-browser-screen__prompt-title></span>
                    <span class="browser-screen__prompt-subtitle" data-browser-screen__prompt-subtitle></span>
                    <button type="button" class="browser-screen__prompt-add">Add to homescreen</button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid__item">
        <div class="device device--nexus-5x">
            <div class="device__viewport device__viewport--nexus-5x home-screen" data-home-screen>
                <button class="home-screen__shortcut">
                    <img alt="" class="home-screen__icon" data-home-screen__icon>
                    <span class="home-screen__name" data-home-screen__name></span>
                </button>
            </div>
        </div>
    </div>

    <div class="grid__item">
        <div class="device device--nexus-5x">
            <div class="device__viewport device__viewport--nexus-5x">
                <div class="splash-screen" data-splash-screen>
                    <img alt="" class="splash-screen__icon" data-splash-screen__icon>
                    <p class="splash-screen__name" data-splash-screen__name></p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid__item">
        <div class="device device--nexus-5x">
            <!-- @todo: add and configure `sandbox` on iframe? -->
            <iframe src="" frameborder="0" data-app-screen 
                class="device__viewport device__viewport--nexus-5x"></iframe>
        </div>
    </div>

</div>

    <script>
    (function(){
        var form = document.querySelector('[data-manifest-form]');
        var browserScreen = document.querySelector('[data-browser-screen]');
        var homeScreen = document.querySelector('[data-home-screen]');
        var splashScreen = document.querySelector('[data-splash-screen]');
        var appScreen = document.querySelector('[data-app-screen]');

        document.querySelector('iframe').addEventListener('error', function(err) {
            console.log('err!', err);
        });

        form.addEventListener('submit', function(event){
            event.preventDefault();

            var siteUrl = form.siteUrl.value;
            var manifest = JSON.parse(form.manifest.value);
            var iconUrl = new URL(getLargestIcon(manifest.icons).src, siteUrl);

            browserScreen.querySelector('[data-browser-screen__url-input]').value = siteUrl;
            browserScreen.querySelector('[data-browser-screen__content]').src = siteUrl;
            browserScreen.querySelector('[data-browser-screen__prompt-icon]').src = iconUrl;
            browserScreen.querySelector('[data-browser-screen__prompt-title]').innerHTML = manifest.name;
            browserScreen.querySelector('[data-browser-screen__prompt-subtitle]').innerHTML = (new URL(siteUrl)).hostname;
            browserScreen.setAttribute('data--loaded', true);

            homeScreen.querySelector('[data-home-screen__icon]').src = iconUrl;
            homeScreen.querySelector('[data-home-screen__name]').innerHTML = manifest.short_name;

            splashScreen.style.backgroundColor = manifest.background_color;
            splashScreen.querySelector('[data-splash-screen__icon]').src = iconUrl;
            splashScreen.querySelector('[data-splash-screen__name]').innerHTML = manifest.name.replace('\n', '<br>');

            appScreen.src = new URL(manifest.start_url, siteUrl);
        });

        form.querySelector('[data-manifest-form__fetch]').addEventListener('click', function(){
            fetch('/manifest?url=' + form.siteUrl.value)
                .then(function(response){ return response.json(); })
                .then(function(response){
                    form.manifest.value = JSON.stringify(response.data, null, 2);
                    validateJsonInput();
                });
        });

        form.manifest.addEventListener('input', validateJsonInput());

        function validateJsonInput() {
            try {
                JSON.parse(form.manifest.value);
                form.manifest.setCustomValidity('');
            } catch (err) {
                form.manifest.setCustomValidity('Input must be valid JSON');
            }
        }

        function getLargestIcon(icons) {
            return icons.map(function(icon) {
                var sizes = icon.sizes.split('x');
                icon.width = sizes[0];
                //icon.height = sizes[1];
                return icon;
            })
            .reduce(function(largestIcon, currentIcon){
                return (currentIcon.width > largestIcon.width) ? currentIcon : largestIcon;
            });
        }

    }());
    </script>
</body>
</html>